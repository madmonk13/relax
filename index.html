<!doctype html>
<html lang="en">
<head>
<title>relax.</title>
<style>
html {
	height: 100%;
}
body {
	background-color: lightblue;
	background: radial-gradient(lightblue,darkblue);
}
#about {
	font-family: Arial, Sans-Serif;
	color: #fff;
	opacity: 0.5;
	display: block;
	width: 100%;
	text-align: center;
	margin-top: 10%;
}
@keyframes droplet {
	0% { opacity: 1.0; transform:scale(1,1);}
	100% { opacity: 0; transform:scale(4,4); }
}
.drop {
	display: block;
	position: fixed;
	animation-name: droplet;
	animation-duration: 3s;
	border: 1px solid #fff;
	background-color: #eee;
	width: 50px;
	height: 50px;
	border-radius: 25px;
	text-align: center;
	font-family: Arial;
	font-size: 12px;
	color: #ddd;
	line-height: 50px;
}
</style>
<script>
var notes = [];
notes['C0'] = 16.351;
notes['C#0'] = 17.324;
notes['Db0'] = 17.324;
notes['D0'] = 18.354;
notes['D#0'] = 19.445;
notes['Eb0'] = 19.445;
notes['E0'] = 20.601;
notes['F0'] = 21.827;
notes['F#0'] = 23.124;
notes['Gb0'] = 23.124;
notes['G0'] = 24.499;
notes['G#0'] = 25.956;
notes['Ab0'] = 25.956;
notes['A0'] = 27.5;
notes['A#0'] = 29.135;
notes['Bb0'] = 29.135;
notes['B0'] = 30.868;
notes['C1'] = 32.703;
notes['C#1'] = 34.648;
notes['Db1'] = 34.648;
notes['D1'] = 36.708;
notes['D#1'] = 38.891;
notes['Eb1'] = 38.891;
notes['E1'] = 41.203;
notes['F1'] = 43.654;
notes['F#1'] = 46.249;
notes['Gb1'] = 46.249;
notes['G1'] = 48.999;
notes['G#1'] = 51.913;
notes['Ab1'] = 51.913;
notes['A1'] = 55;
notes['A#1'] = 58.27;
notes['Bb1'] = 58.27;
notes['B1'] = 61.735;
notes['C2'] = 65.406;
notes['C#2'] = 69.296;
notes['Db2'] = 69.296;
notes['D2'] = 73.416;
notes['D#2'] = 77.782;
notes['Eb2'] = 77.782;
notes['E2'] = 82.407;
notes['F2'] = 87.307;
notes['F#2'] = 92.499;
notes['Gb2'] = 92.499;
notes['G2'] = 97.999;
notes['G#2'] = 103.826;
notes['Ab2'] = 103.826;
notes['A2'] = 110;
notes['A#2'] = 116.541;
notes['Bb2'] = 116.541;
notes['B2'] = 123.471;
notes['C3'] = 130.813;
notes['C#3'] = 138.591;
notes['Db3'] = 138.591;
notes['D3'] = 146.832;
notes['D#3'] = 155.563;
notes['Eb3'] = 155.563;
notes['E3'] = 164.814;
notes['F3'] = 174.614;
notes['F#3'] = 184.997;
notes['Gb3'] = 184.997;
notes['G3'] = 195.998;
notes['G#3'] = 207.652;
notes['Ab3'] = 207.652;
notes['A3'] = 220;
notes['A#3'] = 233.082;
notes['Bb3'] = 233.082;
notes['B3'] = 246.942;
notes['C4'] = 261.626;
notes['C#4'] = 277.183;
notes['Db4'] = 277.183;
notes['D4'] = 293.665;
notes['D#4'] = 311.127;
notes['Eb4'] = 311.127;
notes['E4'] = 329.628;
notes['F4'] = 349.228;
notes['F#4'] = 369.994;
notes['Gb4'] = 369.994;
notes['G4'] = 391.995;
notes['G#4'] = 415.305;
notes['Ab4'] = 415.305;
notes['A4'] = 440;
notes['A#4'] = 466.164;
notes['Bb4'] = 466.164;
notes['B4'] = 493.883;
notes['C5'] = 523.251;
notes['C#5'] = 554.365;
notes['Db5'] = 554.365;
notes['D5'] = 587.33;
notes['D#5'] = 622.254;
notes['Eb5'] = 622.254;
notes['E5'] = 659.255;
notes['F5'] = 698.456;
notes['F#5'] = 739.989;
notes['Gb5'] = 739.989;
notes['G5'] = 783.991;
notes['G#5'] = 830.609;
notes['Ab5'] = 830.609;
notes['A5'] = 880;
notes['A#5'] = 932.328;
notes['Bb5'] = 932.328;
notes['B5'] = 987.767;
notes['C6'] = 1046.502;
notes['C#6'] = 1108.731;
notes['Db6'] = 1108.731;
notes['D6'] = 1174.659;
notes['D#6'] = 1244.508;
notes['Eb6'] = 1244.508;
notes['E6'] = 1318.51;
notes['F6'] = 1396.913;
notes['F#6'] = 1479.978;
notes['Gb6'] = 1479.978;
notes['G6'] = 1567.982;
notes['G#6'] = 1661.219;
notes['Ab6'] = 1661.219;
notes['A6'] = 1760;
notes['A#6'] = 1864.655;
notes['Bb6'] = 1864.655;
notes['B6'] = 1975.533;
notes['C7'] = 2093.005;
notes['C#7'] = 2217.461;
notes['Db7'] = 2217.461;
notes['D7'] = 2349.318;
notes['D#7'] = 2489.016;
notes['Eb7'] = 2489.016;
notes['E7'] = 2637.021;
notes['F7'] = 2793.826;
notes['F#7'] = 2959.955;
notes['Gb7'] = 2959.955;
notes['G7'] = 3135.964;
notes['G#7'] = 3322.438;
notes['Ab7'] = 3322.438;
notes['A7'] = 3520;
notes['A#7'] = 3729.31;
notes['Bb7'] = 3729.31;
notes['B7'] = 3951.066;
notes['C8'] = 4186.009;
notes['C#8'] = 4434.922;
notes['Db8'] = 4434.922;
notes['D8'] = 4698.636;
notes['D#8'] = 4978.032;
notes['Eb8'] = 4978.032;
notes['E8'] = 5274.042;
notes['F8'] = 5587.652;
notes['F#8'] = 5919.91;
notes['Gb8'] = 5919.91;
notes['G8'] = 6271.928;
notes['G#8'] = 6644.876;
notes['Ab8'] = 6644.876;
notes['A8'] = 7040;
notes['A#8'] = 7458.62;
notes['Bb8'] = 7458.62;
notes['B8'] = 7902.132;
notes['C9'] = 8372.018;
notes['C#9'] = 8869.844;
notes['Db9'] = 8869.844;
notes['D9'] = 9397.272;
notes['D#9'] = 9956.064;
notes['Eb9'] = 9956.064;
notes['E9'] = 10548.084;
notes['F9'] = 11175.304;
notes['F#9'] = 11839.82;
notes['Gb9'] = 11839.82;
notes['G9'] = 12543.856;
notes['G#9'] = 13289.752;
notes['Ab9'] = 13289.752;
notes['A9'] = 14080;
notes['A#9'] = 14917.24;
notes['Bb9'] = 14917.24;
notes['B9'] = 15804.264;

var currentTheme = 0;
var theme = new Array();
	theme[0] = new Array("D2","G2","A2","B2","D3","A3","B3","D4","E4","F#4","A4","B4","C#5","D5","E5","F#5","A5");
	theme[1] = new Array("G1","D2","G2","D3","G3","A3","D4","E4","G4","A4","B4","D5","E5","G5");
	theme[2] = new Array("A1","E2","A2","E2","F#2","A3","C4","D4","E4","G4","A4","B4","C5","D5","E5","G5","A5");
	theme[3] = new Array("E2","B2","C#3","E3","F#3","E4","F#4","G#4","B4","C#5","E5","F#5","A5","B5");

var t;
var density = 4000;

var audio = new (window.AudioContext || window.webkitAudioContext)();

window.addEventListener('touchstart', function() {
	// create empty buffer
	var buffer = audio.createBuffer(1, 1, 22050);
	var source = audio.createBufferSource();
	source.buffer = buffer;
	// connect to output (your speakers)
	source.connect(audio.destination);
	// play the file
	source.noteOn(0);
}, false);

if ( window.speechSynthesis ){
	var announce = window.speechSynthesis;
}

function drop(t){
	if ( document.getElementsByTagName("body")[0] ){
		let tid = Math.random()*999999999999;
		let coordx = Math.random()*90 + 5;
		let coordy = Math.random()*90 + 5;
		let thisDrop = document.createElement('div');
			thisDrop.setAttribute("style","left:"+coordx+"%;top:"+coordy+"%;");
			thisDrop.className="drop";
			thisDrop.id = tid;
			thisDrop.innerHTML = t;
		document.getElementsByTagName("body")[0].appendChild(thisDrop);
		setTimeout("document.getElementById('"+tid+"').remove();",2900);
	}
}

function synth(w,f,v,a,l,d,x,y,z) {
	var gain = audio.createGain(),
		osc = audio.createOscillator();
	gain.connect(audio.destination);
	gain.gain.setValueAtTime(0, audio.currentTime);
	gain.gain.linearRampToValueAtTime(v, audio.currentTime + (a / 1000) );
	gain.gain.linearRampToValueAtTime(0, audio.currentTime + ((a / 1000) + (l / 1000) + (d / 1000)) );

	panner = audio.createPanner();
	panner.setPosition(x,y,z);
	osc.connect(panner);
	panner.connect(audio.destination);


	osc.frequency.value = f;
	osc.type = w;
	osc.connect(gain);
	osc.start(0);

	var stoptime = (a + l + d) * 1.1;

	setTimeout(function() {
		osc.stop(0);
		osc.disconnect(gain);
		gain.disconnect(audio.destination);
	}, stoptime )
}

function separateTones(theme,octave){
	let theseNotes = new Array();
		theseNotes['drone'] = new Array();
		theseNotes['melody'] = new Array();
	for ( a = 0 ; a < theme.length ; a++ ){
		if ( theme[a].match(/\d+/)[0] <= octave ){
			theseNotes['drone'].push(theme[a]);
		}
		else {
			theseNotes['melody'].push(theme[a]);
		}
	}
	return theseNotes;
}

function play(notes,theme,currentTheme){
	currentTheme += Math.random()/10;
	if ( currentTheme >= theme.length){
		currentTheme = 0;
	}

	console.log(currentTheme, theme.length);
	let nextPhrase = 0;

	let thisPhrase = separateTones(theme[Math.floor(currentTheme)],2);

	let drone = thisPhrase['drone'][Math.floor(Math.random()*thisPhrase['drone'].length)];
	let phraseLen = Math.floor(Math.random()*thisPhrase['melody'].length);
	let phrase = new Array();
	for (a = 0;a < phraseLen;a++ ){
		phrase.push(thisPhrase['melody'][Math.floor(Math.random()*thisPhrase['melody'].length)]);
	}

	let volume = Math.random()*0.15
	let attack = 10;
	let delay = Math.random()*8000;
	let x = (Math.random()*300 - 150);
	let y = (Math.random()*300 - 150);
	let z = (Math.random()*300 - 150);
	let release = attack + length;
	nextPhrase += release;

	var noteDelay = 0;
	for (b=0;b<=phrase.length;b++){
		let length = density*((Math.floor(Math.random()*8)+1)/8);
		let volume = Math.random()*0.15
		let attack = 10;
		nextPhrase += length;
		let x = (Math.random()*300 - 150);
		let y = (Math.random()*300 - 150);
		let z = (Math.random()*300 - 150);
		let release = attack + length;
		let playNote = notes[theme[b]];
		if ( b < phrase.length ){
			t = setTimeout( 'synth("sine",'+notes[phrase[b]]+','+volume+','+attack+','+length+','+release+','+x+','+y+','+z+');drop("'+phrase[b]+'");', noteDelay );
		}
		else {
			t = setTimeout(function(){play(notes,theme,currentTheme);}, nextPhrase);
		}
		noteDelay += length;
	}

	synth("sine",notes[drone],volume,attack,nextPhrase,release,x,y,z);
	drop(drone);


}

play(notes,theme,currentTheme);

</script>
</head>
<body>
	<div id="about">
		<h1>r e l a x .</h1>
		<p>relax will play randomized ambient music perfect for use as a relaxing background.</p>
	</div>
</body>
</html>
